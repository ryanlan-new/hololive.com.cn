name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Optimization: Use system installed Node.js to avoid slow downloads
      - name: Check Node.js Version
        run: node -v && npm -v

      - name: Install Dependencies (with retry)
        run: |
          set -e
          npm config set registry https://registry.npmmirror.com
          npm config set fetch-retries 5
          npm config set fetch-retry-mintimeout 10000
          npm config set fetch-retry-maxtimeout 120000

          for i in 1 2 3; do
            echo "npm ci attempt ${i}/3"
            if npm ci; then
              exit 0
            fi

            if [ "$i" -lt 3 ]; then
              echo "npm ci failed, retrying in 10s..."
              sleep 10
            fi
          done

          echo "npm ci failed after 3 attempts"
          exit 1

      - name: Lint (Zero Warning)
        run: npm run lint

      - name: Security Audit (Prod Deps, network-resilient)
        run: |
          set +e

          for i in 1 2 3; do
            echo "npm audit attempt ${i}/3"
            output="$(npm run audit:prod 2>&1)"
            status=$?
            echo "$output"

            if [ "$status" -eq 0 ]; then
              exit 0
            fi

            if echo "$output" | grep -Eqi "ENOTFOUND|EAI_AGAIN|ECONNRESET|ETIMEDOUT|ECONNREFUSED|TLS|socket hang up|audit endpoint returned an error|getaddrinfo|Failed to connect"; then
              if [ "$i" -lt 3 ]; then
                echo "Network-related audit failure, retrying in 10s..."
                sleep 10
                continue
              fi

              echo "::warning::Security audit skipped due repeated network errors after 3 attempts."
              exit 0
            fi

            echo "::error::Security audit failed due non-network issue."
            exit "$status"
          done

      - name: Build Frontend
        run: npm run build
        env:
          VITE_POCKETBASE_URL: "https://hololive.com.cn"

      - name: Deploy to Web Root
        run: |
          # The runner is already ON the server.
          # We just need to copy the build artifacts to the web root.
          
          echo "Deploying to /var/www/hololive.com.cn..."
          
          # Copy Frontend Build
          # Assuming /var/www/hololive.com.cn is the target web root
          # Note: 'rsync' is safer than 'cp' for syncing directories
          rsync -av --delete dist/ /var/www/hololive.com.cn/dist/
          
          # Copy Backend Migrations
          rsync -av backend/pb_migrations/ /var/www/hololive.com.cn/backend/pb_migrations/

          # Copy Backend Scripts (e.g. Sync Velocity)
          rsync -av backend/scripts/ /var/www/hololive.com.cn/backend/scripts/

          # Ensure map-proxy service + nginx route are installed/updated
          sudo chmod +x /var/www/hololive.com.cn/backend/scripts/setup_map_proxy.sh
          sudo /var/www/hololive.com.cn/backend/scripts/setup_map_proxy.sh
          
          # Restart PocketBase and Velocity Sync Service
          # Note: The runner user must have permission to run this (e.g. root or sudo w/o password)
          sudo systemctl restart pocketbase
          sudo systemctl restart velocity-sync
          sudo systemctl restart map-proxy
          
          echo "Deployment successful."
